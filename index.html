<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>√ìptica Cristal ¬∑ Carga r√°pida</title>
<link rel="stylesheet" href="css/estilos.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>.msg{margin-top:8px;font-size:14px}</style>
</head>
<body>
<div class="wrap">
  <h1>Carga de trabajos (r√°pida)</h1>

  <form id="f" autocomplete="off" onsubmit="return false;">
    <div class="grid two">
      <div class="card">
        <label>Fecha que encarga</label>
        <input id="fecha" name="fecha" />

        <label>Modalidad de entrega</label>
        <select id="entrega" name="entrega">
          <option>STOCK</option><option>URGENTE</option><option>LABORATORIO</option>
        </select>

        <label>Fecha que retira (estimada)</label>
        <input id="fecha_retira" name="fecha_retira" type="date" />

        <label>N√∫mero de trabajo</label>
        <input id="nro" name="nro" inputmode="numeric" required>

        <label>DNI</label><input id="dni" name="dni" inputmode="numeric">
        <label>Apellido y nombre</label><input id="nombre" name="nombre">
        <label>Tel√©fono</label><input id="telefono" name="telefono" inputmode="tel">
        <label>Localidad</label><input id="localidad" name="localidad">

        <label>Tipo de cristal</label><input id="cristal" name="cristal">
        <label>Precio cristal</label><input id="precio_cristal" name="precio_cristal" inputmode="numeric">

        <label>Concepto negativo (detalle)</label><input id="obra_social" name="obra_social">
        <label>- Descuento (importe)</label><input id="precio_obra_social" name="precio_obra_social" inputmode="numeric">

        <div class="grid three">
          <div><label>OD ESF</label><input id="od_esf" name="od_esf"></div>
          <div><label>OD CIL</label><input id="od_cil" name="od_cil"></div>
          <div><label>OD EJE</label><input id="od_eje" name="od_eje"></div>
          <div><label>OI ESF</label><input id="oi_esf" name="oi_esf"></div>
          <div><label>OI CIL</label><input id="oi_cil" name="oi_cil"></div>
          <div><label>OI EJE</label><input id="oi_eje" name="oi_eje"></div>
        </div>

        <div class="grid three">
          <div><label>ADD</label><input id="add" name="add"></div>
          <div><label>DNP</label><input id="dnp" name="dnp"></div>
          <div><label>Distancia focal (obligatorio)</label>
            <select id="distancia_focal" name="distancia_focal" required>
              <option value="" disabled selected>Eleg√≠ una</option>
              <option>MONOFOCAL LEJOS</option>
              <option>MONOFOCAL CERCA</option>
              <option>BIFOCAL</option>
              <option>MULTIFOCAL</option>
              <option>OCUPACIONAL</option>
              <option>MONOFOCAL INTERMEDIA</option>
              <option>SOBRE LC</option>
            </select>
          </div>
        </div>

        <label>Otro concepto</label><input id="otro_concepto" name="otro_concepto">
        <label>Precio otro</label><input id="precio_otro" name="precio_otro" inputmode="numeric">

        <label>Vendedor</label><input id="vendedor" name="vendedor">
        <label>Forma de pago</label><input id="forma_pago" name="forma_pago">

        <label>N¬∫ armaz√≥n</label><input id="n_anteojo" name="n_anteojo">
        <label>Detalle armaz√≥n</label><input id="detalle_armazon" name="detalle_armazon">
        <label>Precio armaz√≥n</label><input id="precio_armazon" name="precio_armazon" inputmode="numeric">

        <div class="grid three">
          <div><label>Total</label><input id="total" name="total" inputmode="numeric"></div>
          <div><label>Se√±a</label><input id="sena" name="sena" inputmode="numeric"></div>
          <div><label>Saldo</label><input id="saldo" name="saldo" inputmode="numeric"></div>
        </div>

        <label>Foto receta (opcional)</label>
        <input type="file" id="foto" accept="image/*">
      </div>
    </div>

    <div class="actions">
      <button id="btnGuardar" type="button">üíæ Guardar r√°pido</button>
      <a href="entregar.html" class="secondary">Ir a Entregar</a>
      <div id="msg" class="msg"></div>
    </div>
  </form>
</div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbwVmlfFxAycG_TBSGGdgmPafrdz1a5nemrGL2CJ-Tlcl4ZOiH96CLlkp-qsm5X8MXCO9g/exec';

const $ = s => document.querySelector(s);
const setMsg = (t,ok=true)=>{ const m=$("#msg"); m.textContent=t; m.style.color=ok?'#2aa745':'#e66464'; };

async function uploadPhotoIfAny(){
  const f = $('#foto'); if (!f.files || !f.files[0]) return '';
  const fd = new FormData(); fd.append('action','upload_photo'); fd.append('file', f.files[0]);
  const r = await fetch(API_URL,{method:'POST',body:fd}); const j = await r.json();
  if (!j.ok) throw new Error(j.error); return j.fileId;
}

async function guardar(){
  try{
    setMsg('Guardando‚Ä¶', true);
    const fotoId = await uploadPhotoIfAny().catch(()=>'');

    const p = new URLSearchParams();
    p.set('action','save');

    // Campos (coinciden con script.gs)
    [
      'fecha','fecha_retira','nro','dni','nombre','telefono','localidad',
      'cristal','precio_cristal','obra_social','precio_obra_social',
      'od_esf','od_cil','od_eje','oi_esf','oi_cil','oi_eje','add','dnp','distancia_focal',
      'otro_concepto','precio_otro','vendedor','forma_pago',
      'n_anteojo','detalle_armazon','precio_armazon',
      'total','sena','saldo','entrega'
    ].forEach(id => { const el = document.getElementById(id); if (el) p.set(id, el.value || ''); });

    if (fotoId) p.set('foto_receta_id', fotoId);

    const r = await fetch(API_URL,{method:'POST',body:p});
    const j = await r.json();
    if (!j.ok) throw new Error(j.error);
    setMsg('Guardado ‚úîÔ∏è N¬∫ '+j.nro);
    Swal.fire({icon:'success',title:'Guardado r√°pido',text:'N¬∫ '+j.nro,timer:1500,showConfirmButton:false});
  }catch(err){
    setMsg('Error: '+(err.message||err), false);
    Swal.fire({icon:'error',title:'Error',text:String(err)});
  }
}

$('#btnGuardar').addEventListener('click', guardar);

// Defaults simples
document.getElementById('fecha').value = new Date().toLocaleDateString('es-AR');
</script>
</body>
</html>
